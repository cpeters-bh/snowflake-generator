
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trigonometric Snowflake Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIX: KaTeX CSS for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" xintegrity="sha384-Gvr4VtJ267sFwP1rR+8iO3sB8wKzQx6Cg4n8c+j5k3U/fEwS6lP3B4N1d9g4u1fP4" crossorigin="anonymous">
    <!-- FIX: KaTeX JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" xintegrity="sha384-q703XzQx8g8F5/M5T/3lqCg6+m4G7f6M/B/o3V4P3j6xW12z2/1P4Z7hS5" crossorigin="anonymous"></script>

    <style>
        /* Custom styles for aesthetic drawing */
        #snowflake-svg {
            stroke: #3b82f6; /* Blue-500 */
            stroke-width: 2.5;
            fill: none;
            transition: all 0.2s ease-out;
            transform: scale(1);
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
        }

        /* Ensure smooth slider handles */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        .layer-control-container {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }
        /* Custom style for equation box */
        .equation-box {
            background-color: #eff6ff; /* blue-50 */
            border: 1px solid #bfdbfe; /* blue-200 */
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            font-size: 0.875rem; /* text-sm */
            font-family: sans-serif; /* Changed to sans-serif for better math display */
            color: #374151; /* gray-700 */
            overflow-x: auto;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4 font-sans">

    <div class="max-w-4xl w-full flex flex-col md:flex-row gap-6">

        <!-- Controls Panel -->
        <div id="controls" class="bg-white p-6 rounded-xl shadow-lg md:w-1/3 h-fit">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Snowflake Parameters</h2>
            <p class="text-sm text-gray-600 mb-4">
                Available Equations use parameters R₀ (Base), A (Amplitude), B (Detail), and K (Frequency).
            </p>

            <div class="space-y-5">
                
                <!-- Global Controls -->
                <h3 class="text-lg font-semibold text-gray-700 mt-4 border-t pt-4">Drawing Quality</h3>
                <div class="slider-group">
                    <label for="resolution" class="block text-sm font-medium text-gray-700">
                        Line Resolution (Points): <span id="resValue" class="font-semibold text-blue-600">360</span>
                    </label>
                    <input type="range" id="resolution" min="100" max="1000" value="360" step="10" class="w-full h-2 bg-blue-100 rounded-lg appearance-none cursor-pointer">
                </div>

                <!-- Layer 1 Controls (Static Base Layer) -->
                <h3 class="text-lg font-semibold text-gray-700 mt-8 border-t pt-4">Layer 1 (Base)</h3>
                
                <!-- NEW: Equation Selector -->
                <div class="input-group">
                    <label for="equationSelect1" class="block text-sm font-medium text-gray-700">Equation Type:</label>
                    <select id="equationSelect1" class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="TRIG" selected>Trigonometric Star (A cos(Kθ) + B sin(2Kθ))</option>
                        <option value="POLY">Polynomial Flower (R₀ + A sin²(Kθ))</option>
                        <option value="SYMMETRIC">Symmetric Petals (R₀ + A |cos(Kθ)|)</option>
                    </select>
                </div>
                
                <div class="slider-group">
                    <label for="baseRadius1" class="block text-sm font-medium text-gray-700">
                        Base Radius (R₀): <span id="r0Value1" class="font-semibold text-blue-600">120</span>
                    </label>
                    <input type="range" id="baseRadius1" data-param="R0" min="50" max="200" value="120" step="10" class="w-full h-2 bg-blue-100 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="slider-group">
                    <label for="armAmplitude1" class="block text-sm font-medium text-gray-700">
                        Amplitude A: <span id="aValue1" class="font-semibold text-blue-600">40</span>
                    </label>
                    <input type="range" id="armAmplitude1" data-param="A" min="0" max="80" value="40" step="5" class="w-full h-2 bg-blue-100 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="slider-group">
                    <label for="detailAmplitude1" class="block text-sm font-medium text-gray-700">
                        Detail Amplitude B: <span id="bValue1" class="font-semibold text-blue-600">20</span>
                    </label>
                    <input type="range" id="detailAmplitude1" data-param="B" min="0" max="60" value="20" step="5" class="w-full h-2 bg-blue-100 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="slider-group">
                    <label for="frequencyK1" class="block text-sm font-medium text-gray-700">
                        Frequency K: <span id="kValue1" class="font-semibold text-blue-600">6</span>
                    </label>
                    <input type="range" id="frequencyK1" data-param="K" min="2" max="12" value="6" step="1" class="w-full h-2 bg-blue-100 rounded-lg appearance-none cursor-pointer">
                </div>
                
                <!-- Layer 1 Equation Display -->
                <div id="equationDisplay1" class="equation-box">
                    <!-- Specific equation will be inserted here -->
                </div>
            </div>

            <!-- Dynamic Layer Container -->
            <div id="dynamic-layers" class="space-y-8 mt-8 border-t pt-4">
                <!-- Dynamic layers will be appended here -->
            </div>

            <!-- Add Layer Button -->
            <button id="addLayerButton" class="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                + Add Drawing Layer
            </button>

            <!-- Export Button -->
            <button id="exportButton" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                Export SVG File
            </button>
        </div>

        <!-- Drawing Area -->
        <div class="flex-grow bg-white p-2 rounded-xl shadow-lg flex items-center justify-center overflow-hidden">
            <svg id="snowflake-svg" width="500" height="500" viewBox="0 0 500 500"></svg>
        </div>

    </div>

    <script>
        // --- Core Elements ---
        const svgElement = document.getElementById('snowflake-svg');
        const exportButton = document.getElementById('exportButton');
        const addLayerButton = document.getElementById('addLayerButton');
        const dynamicLayersContainer = document.getElementById('dynamic-layers');
        const RES_input = document.getElementById('resolution');
        const RES_span = document.getElementById('resValue');

        // Center coordinates of the SVG (500x500 viewBox)
        const CX = 250;
        const CY = 250;

        // Color array for dynamic layers
        const layerColors = ['#065f46', '#7c3aed', '#b91c1c', '#d97706'];
        
        // --- State Management ---
        let nextLayerId = 2; // ID for the next layer to be created
        
        // Array to store parameters for all dynamic layers (Layer 1 is static HTML)
        let dynamicLayers = [];

        // --- Equation Logic Mapping (REMOVED $$ delimiters) ---
        const EQUATION_LOGIC = {
            'TRIG': {
                // Original Trigonometric Star: r = R0 + A*cos(K*theta) + B*sin(2*K*theta)
                formula: (R0, A, B, K, theta) => R0 + A * Math.cos(K * theta) + B * Math.sin(2 * K * theta),
                display: (R0, A, B, K) => `r(\\theta) = ${R0} + ${A} \\cos(${K}\\theta) + ${B} \\sin(2 \\cdot ${K}\\theta)`
            },
            'POLY': {
                // Polynomial Flower: r = R0 + A*sin^2(K*theta)
                formula: (R0, A, B, K, theta) => R0 + A * Math.pow(Math.sin(K * theta), 2),
                display: (R0, A, B, K) => `r(\\theta) = ${R0} + ${A} \\sin^2(${K}\\theta)`
            },
            'SYMMETRIC': {
                // Symmetric Petals: r = R0 + A*abs(cos(K*theta))
                formula: (R0, A, B, K, theta) => R0 + A * Math.abs(Math.cos(K * theta)),
                display: (R0, A, B, K) => `r(\\theta) = ${R0} + ${A} |\\cos(${K}\\theta)|`
            }
        };

        // --- Utility Functions ---

        // Gets the parameters for the static Layer 1
        function getLayer1Params() {
            return {
                id: 1,
                R0: parseFloat(document.getElementById('baseRadius1').value),
                A: parseFloat(document.getElementById('armAmplitude1').value),
                B: parseFloat(document.getElementById('detailAmplitude1').value),
                K: parseInt(document.getElementById('frequencyK1').value),
                equationType: document.getElementById('equationSelect1').value, 
                stroke: '#3b82f6', // Base layer color
                strokeWidth: 2.5
            };
        }
        
        // UPDATED: Renders the mathematical equation using KaTeX
        function updateEquationDisplay(layerId, params) {
            const element = document.getElementById(`equationDisplay${layerId}`);
            
            // Check if element and KaTeX are ready
            if (!element || typeof katex === 'undefined') {
                // Fallback: display raw string
                if (element) {
                     const logic = EQUATION_LOGIC[params.equationType] || EQUATION_LOGIC['TRIG'];
                     element.innerHTML = '$$' + logic.display(params.R0, params.A, params.B, params.K) + '$$';
                }
                return;
            }
            
            const K_val = Math.round(params.K); 
            const R0 = params.R0;
            const A = params.A;
            const B = params.B;
            
            const logic = EQUATION_LOGIC[params.equationType] || EQUATION_LOGIC['TRIG'];
            const mathString = logic.display(R0, A, B, K_val);

            // Render the equation using KaTeX
            try {
                katex.render(mathString, element, {
                    throwOnError: false,
                    displayMode: true // Forces it to be centered display math
                });
            } catch (error) {
                console.error("KaTeX rendering error:", error);
                element.innerHTML = `<span style="color:red; font-family:sans-serif;">Math Error: ${error.message}</span>`;
            }
        }

        // Shared function to calculate path data for a given set of parameters
        function calculatePath(R0, A, B, K, equationType, RESOLUTION) {
            let pathData = '';
            
            const logic = EQUATION_LOGIC[equationType] || EQUATION_LOGIC['TRIG'];

            for (let i = 0; i <= RESOLUTION; i++) {
                // Theta ranges from 0 to 2*PI
                const theta = i * (2 * Math.PI / RESOLUTION);

                // Calculate radius using the selected formula
                const r = logic.formula(R0, A, B, K, theta);

                // Convert polar coordinates (r, theta) to Cartesian coordinates (x, y)
                const x = CX + r * Math.cos(theta);
                const y = CY + r * Math.sin(theta);

                if (i === 0) {
                    pathData = `M${x},${y}`;
                } else {
                    pathData += ` L${x},${y}`;
                }
            }
            return pathData + ' Z';
        }

        // --- Dynamic Layer Management ---

        function getLayerTemplate(id, color) {
            // Default values for new layers
            const defaultR0 = 100;
            const defaultA = 30;
            const defaultB = 10;
            const defaultK = 4;
            const defaultEq = 'TRIG';
            
            // Initial equation text will be replaced by katex.render after elements are in DOM
            const initialEquation = "Loading equation..."; 


            return `
                <div id="layer-${id}" class="layer-control-container space-y-4" data-layer-id="${id}" data-color="${color}">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold text-gray-700" style="color:${color}">Layer ${id}</h3>
                        <button class="remove-layer-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded transition" data-layer-id="${id}">
                            Remove
                        </button>
                    </div>

                    <!-- NEW: Equation Selector -->
                    <div class="input-group">
                        <label for="equationSelect${id}" class="block text-sm font-medium text-gray-700">Equation Type:</label>
                        <select id="equationSelect${id}" data-param="equationType" class="equation-select w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="TRIG" selected>Trigonometric Star (A cos(Kθ) + B sin(2Kθ))</option>
                            <option value="POLY">Polynomial Flower (R₀ + A sin²(Kθ))</option>
                            <option value="SYMMETRIC">Symmetric Petals (R₀ + A |cos(Kθ)|)</option>
                        </select>
                    </div>

                    <!-- Base Radius (R0) -->
                    <div class="slider-group">
                        <label for="baseRadius${id}" class="block text-sm font-medium text-gray-700">
                            Base Radius (R₀): <span id="r0Value${id}" class="font-semibold" style="color:${color}">${defaultR0}</span>
                        </label>
                        <input type="range" id="baseRadius${id}" data-param="R0" min="50" max="200" value="${defaultR0}" step="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Arm Amplitude (A) -->
                    <div class="slider-group">
                        <label for="armAmplitude${id}" class="block text-sm font-medium text-gray-700">
                            Amplitude A: <span id="aValue${id}" class="font-semibold" style="color:${color}">${defaultA}</span>
                        </label>
                        <input type="range" id="armAmplitude${id}" data-param="A" min="0" max="80" value="${defaultA}" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Detail Amplitude (B) -->
                    <div class="slider-group">
                        <label for="detailAmplitude${id}" class="block text-sm font-medium text-gray-700">
                            Detail Amplitude B: <span id="bValue${id}" class="font-semibold" style="color:${color}">${defaultB}</span>
                        </label>
                        <input type="range" id="detailAmplitude${id}" data-param="B" min="0" max="60" value="${defaultB}" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    
                    <!-- Frequency (K) -->
                    <div class="slider-group">
                        <label for="frequencyK${id}" class="block text-sm font-medium text-gray-700">
                            Frequency K: <span id="kValue${id}" class="font-semibold" style="color:${color}">${defaultK}</span>
                        </label>
                        <input type="range" id="frequencyK${id}" data-param="K" min="2" max="12" value="${defaultK}" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Equation Display -->
                    <div id="equationDisplay${id}" class="equation-box">
                        ${initialEquation}
                    </div>
                </div>
            `;
        }

        function addLayer() {
            const id = nextLayerId;
            const color = layerColors[(id - 2) % layerColors.length]; // Cycle through colors
            
            // 1. Add HTML template
            const template = document.createElement('div');
            template.innerHTML = getLayerTemplate(id, color).trim();
            dynamicLayersContainer.appendChild(template.firstChild);

            // 2. Add data object to state array
            const newLayer = {
                id: id,
                R0: 100,
                A: 30,
                B: 10,
                K: 4,
                equationType: 'TRIG', // NEW default
                stroke: color,
                strokeWidth: 1.5
            };
            dynamicLayers.push(newLayer);

            // 3. Attach listeners to new elements
            const layerElement = document.getElementById(`layer-${id}`);
            // Listeners for sliders
            layerElement.querySelectorAll('input[type="range"]').forEach(input => {
                input.addEventListener('input', updateDynamicLayer);
            });
            // Listener for equation selection
            layerElement.querySelector('.equation-select').addEventListener('change', updateDynamicLayer);

            layerElement.querySelector('.remove-layer-btn').addEventListener('click', removeLayer);

            // 4. Update equation display with initial values (now triggers KaTeX render)
            updateEquationDisplay(id, newLayer);

            nextLayerId++;
            generateSnowflake(); // Redraw with new layer
        }
        
        function removeLayer(event) {
            const idToRemove = parseInt(event.target.getAttribute('data-layer-id'));
            
            // 1. Remove from state array
            dynamicLayers = dynamicLayers.filter(layer => layer.id !== idToRemove);
            
            // 2. Remove from DOM
            const layerElement = document.getElementById(`layer-${idToRemove}`);
            if (layerElement) {
                layerElement.remove();
            }

            // 3. Redraw
            generateSnowflake();
        }

        function updateDynamicLayer(event) {
            const input = event.target;
            const param = input.getAttribute('data-param');
            const layerControl = input.closest('.layer-control-container');
            if (!layerControl) return;

            const layerId = parseInt(layerControl.getAttribute('data-layer-id'));
            
            // Find the layer object
            const layer = dynamicLayers.find(l => l.id === layerId);
            if (!layer) return;

            if (param === 'equationType') {
                layer[param] = input.value;
            } else {
                const value = parseFloat(input.value);
                layer[param] = (param === 'K') ? parseInt(input.value) : value;

                // Update the span value in the UI (only for sliders)
                const spanId = (param === 'R0' ? 'r0Value' : param.toLowerCase() + 'Value') + layerId;
                const span = document.getElementById(spanId);
                if (span) {
                    span.textContent = value;
                }
            }

            // Update the equation display for this layer
            updateEquationDisplay(layerId, layer);

            generateSnowflake();
        }


        // --- Core Drawing Function (Updated) ---
        function generateSnowflake() {
            // Update global resolution span
            const RESOLUTION = parseInt(RES_input.value);
            RES_span.textContent = RESOLUTION;
            
            // Clear existing SVG
            svgElement.innerHTML = '';

            // Combine all layers (Layer 1 static + Dynamic Layers)
            const layer1Params = getLayer1Params();
            const allLayers = [layer1Params, ...dynamicLayers];
            
            // Update Layer 1 equation display (triggers KaTeX render)
            updateEquationDisplay(1, layer1Params);


            // Draw each layer
            allLayers.forEach(layer => {
                // 1. Generate path data
                const pathData = calculatePath(layer.R0, layer.A, layer.B, layer.K, layer.equationType, RESOLUTION);

                // 2. Create and configure SVG path element
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                
                path.setAttribute('d', pathData);
                path.setAttribute('data-layer-id', layer.id);
                path.setAttribute('stroke', layer.stroke);
                path.setAttribute('stroke-width', layer.strokeWidth.toString());
                path.setAttribute('fill', 'none');
                
                svgElement.appendChild(path);
            });
        }

        // NEW: Function to handle input for Layer 1 sliders and update their display spans
        function handleLayer1Input(event) {
            const input = event.target;
            
            // 1. Update the display span for the slider value if it's a range input
            if (input.type === 'range') {
                const param = input.getAttribute('data-param');
                const value = parseFloat(input.value);
                // Construct the span ID for Layer 1
                const spanId = (param === 'R0' ? 'r0Value' : param.toLowerCase() + 'Value') + '1';
                const span = document.getElementById(spanId);
                
                if (span) {
                    span.textContent = value;
                }
            }
            // 2. Redraw the snowflake and update equation display
            generateSnowflake();
        }


        // --- Export Function (Updated) ---
        function exportSVG() {
            const svgContent = svgElement.outerHTML;
            
            // 1. Create download link
            const xmlHeader = '<?xml version="1.0" standalone="no"?>\r\n';
            const svgData = xmlHeader + svgContent;

            const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.setAttribute('href', url);
            // We need to dynamically get the count of layers for the filename
            const layerCount = document.querySelectorAll('.layer-control-container').length + 1;
            link.setAttribute('download', `multi_layered_snowflake_${layerCount}_layers.svg`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // --- Initialization and Listeners ---
        
        // Listener for Layer 1 (Static) and Resolution
        const staticInputs = [
            document.getElementById('baseRadius1'),
            document.getElementById('armAmplitude1'),
            document.getElementById('detailAmplitude1'),
            document.getElementById('frequencyK1'),
            document.getElementById('equationSelect1'), 
            RES_input
        ];

        // UPDATED: Use handleLayer1Input for all static controls to ensure UI updates happen for sliders
        staticInputs.forEach(input => {
            // 'input' event for real-time slider drag updates
            input.addEventListener('input', handleLayer1Input); 
            // 'change' event for select boxes or final value
            input.addEventListener('change', handleLayer1Input);
        });
        
        // Listener for dynamic layer addition
        addLayerButton.addEventListener('click', addLayer);

        // Listener for export
        exportButton.addEventListener('click', exportSVG);

        // Initial draw on load
        // NOTE: We wrap generateSnowflake in a timeout to ensure KaTeX has fully loaded 
        // its scripts and is ready to render when the page loads.
        window.onload = () => {
             // Give KaTeX a moment to initialize after window load
            setTimeout(generateSnowflake, 100); 
        };
    </script>

</body>
</html>
